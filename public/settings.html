<html>
  <head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
  </head>
  <body>
    <div id="content">
      <div id="instruction">
        <h3>Permissions successfully granted! Now it is time to config Smart Deadline.</h3>
        <hr/>
      </div>
      <p>Link to iCal-Calendar:</p>
      <input type="text" id="linkToCal" />
      <p>Distribute over several appointments:</p>
      <input
        type="checkbox"
        id="isContinuous"
        name="isContinuous"
        value="true"
        style="margin-left: 3px"
      />
      <p>Only appointments containing this title:</p>
      <small>Empty uses all events.</small>
      <input type="text" id="patternToUse" />
      <p>
        <button id="save" class="mod-primary" style="width:100%">Save</button>
      </p>
    </div>

    <script>
      var Promise = TrelloPowerUp.Promise;
      var t = TrelloPowerUp.iframe();
      
      var isInstructions = t.arg("isInstructions");
      if (isInstructions) {
        document.getElementById('content').style.margin = '20px';
        document.getElementById('content').style.textAlign = 'center';
      }else{
        document.getElementById('instruction').style.display = 'none';
      }

      var linkToCalSelector = document.getElementById("linkToCal");
      var isContinuousSelector = document.getElementById("isContinuous");
      var patternToUseSelector = document.getElementById("patternToUse");

      t.render(function() {
        return Promise.all([
          t.get("board", "private", "linkToCal"),
          t.get("board", "private", "isContinuous"),
          t.get("board", "private", "patternToUse")
        ])
          .spread(function(
            savedLinkToCal,
            savedIsContinuous,
            savedPatternToUse
          ) {
            if (savedLinkToCal) {
              linkToCalSelector.value = savedLinkToCal;
            }
            if (savedIsContinuous) {
              isContinuousSelector.checked = true;
            }
            if (savedPatternToUse) {
              patternToUseSelector.value = savedPatternToUse;
            }
          })
          .then(function() {
            t.sizeTo("#content").done();
          });
      });

      document.getElementById("save").addEventListener("click", function() {
        return t
          .set("board", "private", "linkToCal", linkToCalSelector.value)
          .then(function() {
            return t
              .set(
                "board",
                "private",
                "isContinuous",
                isContinuousSelector.checked
              )
              .then(function() {
                return t.set(
                  "board",
                  "private",
                  "patternToUse",
                  patternToUseSelector.value ? patternToUseSelector.value : ""
                );
              });
          })
          .then(function() {
            t.closePopup();
          });
      });
    </script>
  </body>
</html>
