<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
  </head>
  <body>
    <div id="content">
      <p>
      To set the due dates in your cards, Smart Deadlines going to need you to authorize it
      to access your Trello account!
    </p>
    <button id="auth-btn" type="submit" class="mod-primary">
      Authorize access to Trello
    </button>
    </div>
    
    <script>
      var Promise = TrelloPowerUp.Promise;
      var t = TrelloPowerUp.iframe();

      var apiKey = t.arg("apiKey");
      var isModal = t.arg("isModal");
      if (isModal) {
        document.getElementById('content').style.margin = '20px';
        document.getElementById('content').style.textAlign = 'center';
      }

      var trelloAuthUrl = `https://trello.com/1/authorize?expiration=never&name=Smart%20Deadlines&scope=read,write&key=${apiKey}&callback_method=fragment&return_url=${window.location.origin}%2Fsmart-deadlines%2Fpublic%2Fauth-success.html`;

      var tokenLooksValid = function(token) {
        return /^[0-9a-f]{64}$/.test(token);
      };

      document.getElementById("auth-btn").addEventListener("click", function() {
        t.authorize(trelloAuthUrl, {
          height: 680,
          width: 580,
          validToken: tokenLooksValid
        })
          .then(function(token) {
            return t.set("member", "private", "token", token).then(function() {
              return t
                .set("board", "private", "isContinuous", true)
                .then(function() {
                  return t.set("board", "private", "patternToUse", "");
                });
            });
          })
          .then(function() {
            if (isModal) {
            
              t.closeModal();
              
              return t.modal({
                // the url to load for the iframe
                url: "/smart-deadlines/public/settings.html",
                args: { isInstructions: true },
                accentColor: "#CDD3D8",
                height: 400,
                fullscreen: false,
                title: "Setup - Step 2",
                actions: []
              });
            }
            return t.closePopup();
          });
      });
    </script>
  </body>
</html>
